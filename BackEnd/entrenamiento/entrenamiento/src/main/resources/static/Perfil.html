<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoachSync ‚Äì Perfil</title>

  <!-- Estilos compartidos -->
  <link rel="stylesheet" href="/styles/roles.css" />
  <!-- Estilos espec√≠ficos de perfil -->
  <link rel="stylesheet" href="/styles/perfil.css" />
</head>
<body>
  <!-- Navbar lateral -->
  <nav class="navbar">
    <div class="nav-logo">
      <img src="/images/logoCS.png" alt="Logo CoachSync" />
      <span>CoachSync</span>
    </div>
    <ul class="nav-links">
      <li><a href="/tutorial-entrenador.html">Tutorial</a></li>
      <li><a href="/roles/entrenador.html">Dashboard</a></li>
      <li><a href="/roles/perfil.html" class="active">Perfil</a></li>
      <li><a href="/logout">Cerrar Sesi√≥n</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <header class="role-header">
      <h1>Mi Perfil</h1>
      <p>Visualiza y actualiza tus datos de usuario</p>
    </header>

    <!-- ==================================== -->
    <!--   SECCI√ìN: FOTO DE PERFIL + INPUT   -->
    <!-- ==================================== -->
    <div class="profile-photo-wrapper">
      <!-- T√≠tulo de la secci√≥n -->
      <h2 class="photo-title">Foto de Perfil</h2>

      <!-- Imagen actual o placeholder -->
      <img
        src="/images/avatar-placeholder.png"
        alt="Foto de Perfil"
        id="profile-photo"
        class="profile-photo"
      />

      <!-- Bot√≥n inicial: ‚ÄúActualizar Imagen‚Äù -->
      <button id="show-url-input-btn" class="upload-button">
        üåê Actualizar Imagen
      </button>
    </div> <!-- .profile-photo-wrapper -->

    <!-- Contenedor para el input de URL + bot√≥n ‚ÄúActualizar Imagen‚Äù -->
    <div class="photo-url-container">
      <input
        type="url"
        id="photo-url-input"
        class="upload-input"
        placeholder="https://dominio.com/mi-foto.jpg"
      />
      <button id="save-url-btn" class="save-url-button">
        üåê Actualizar Imagen
      </button>
    </div> <!-- .photo-url-container -->

    <!-- ==================================== -->
    <!--   SECCI√ìN: INFORMACI√ìN DE USUARIO    -->
    <!-- ==================================== -->
    <ul class="profile-info-list">
      <li>
        <span class="profile-info-label">Email:</span>
        <span id="info-email">Cargando...</span>
      </li>
      <li>
        <span class="profile-info-label">Nombre:</span>
        <span id="info-nombre">Cargando...</span>
      </li>
      <li>
        <span class="profile-info-label">Edad:</span>
        <span id="info-edad">Cargando...</span>
      </li>
      <li>
        <span class="profile-info-label">Usuario:</span>
        <span id="info-username">Cargando...</span>
      </li>
      <li>
        <span class="profile-info-label">Rol:</span>
        <span id="info-role">Cargando...</span>
      </li>
    </ul>

    <!-- Bot√≥n para editar perfil -->
    <button class="edit-button" onclick="window.location.href='/roles/editar-perfil.html'">
      Editar Perfil
    </button>
  </div> <!-- .main-content -->

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 CoachSync. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const profilePhoto = document.getElementById('profile-photo');
      const showUrlBtn   = document.getElementById('show-url-input-btn');
      const urlContainer = document.querySelector('.photo-url-container');
      const urlInput     = document.getElementById('photo-url-input');
      const saveUrlBtn   = document.getElementById('save-url-btn');

      // Obtiene datos de usuario (incluida la URL de la foto, si existe)
      fetch('/api/me')
        .then(response => {
          if (!response.ok) throw new Error('No se pudo cargar la informaci√≥n del usuario.');
          return response.json();
        })
        .then(data => {
          document.getElementById('info-email').textContent    = data.email;
          document.getElementById('info-nombre').textContent   = data.nombre;
          document.getElementById('info-edad').textContent     = data.edad;
          document.getElementById('info-username').textContent = data.username;
          const rol = data.role.startsWith('ROLE_')
                        ? data.role.substring(5).toLowerCase()
                        : data.role;
          document.getElementById('info-role').textContent =
            rol.charAt(0).toUpperCase() + rol.slice(1);

          // Si ya existe una URL de foto, mostrarla y desplegar el input
          if (data.photoFilename && data.photoFilename.startsWith('http')) {
            profilePhoto.src = data.photoFilename;
            urlInput.value   = data.photoFilename;
            showUrlBtn.style.display   = 'none';
            urlContainer.style.display = 'flex';
          }
        })
        .catch(err => {
          console.error(err);
          const spans = document.querySelectorAll('.profile-info-list span:nth-child(2)');
          spans.forEach(span => span.textContent = 'No disponible');
        });

      // Al hacer clic en ‚ÄúActualizar Imagen‚Äù, mostrar el input + bot√≥n
      showUrlBtn.addEventListener('click', () => {
        showUrlBtn.style.display   = 'none';
        urlContainer.style.display = 'flex';
      });

      // Al hacer clic en ‚ÄúActualizar Imagen‚Äù dentro del contenedor:
      saveUrlBtn.addEventListener('click', () => {
        const url = urlInput.value.trim();
        if (!url) {
          alert('Ingresa primero la URL de tu foto.');
          return;
        }
        if (!/^https?:\/\//.test(url)) {
          alert('La URL debe comenzar con http:// o https://');
          return;
        }

        // Vista previa inmediata
        profilePhoto.src = url;

        // Enviar la URL al servidor
        fetch('/api/me/photo-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ photoUrl: url })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Error al actualizar la imagen.');
          }
          return response.text();
        })
        .then(msg => {
          console.log('Servidor respondi√≥:', msg);
          // Opcional: notificar al usuario de √©xito
        })
        .catch(err => {
          console.error(err);
          alert('No se pudo actualizar la imagen. Intenta de nuevo.');
        });
      });
    });
  </script>
</body>

</html>
