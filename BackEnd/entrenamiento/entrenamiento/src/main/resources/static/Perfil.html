<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CoachSync – Perfil</title>

  <!-- Estilos compartidos -->
  <link rel="stylesheet" href="/styles/roles.css" />
  <!-- Estilos específicos de perfil -->
  <link rel="stylesheet" href="/styles/perfil.css" />
</head>
<body>
  <!-- Navbar lateral -->
  <nav class="navbar">
    <div class="nav-logo">
      <img src="/images/logoCS.png" alt="Logo CoachSync" />
      <span>CoachSync</span>
    </div>
    <ul class="nav-links">
      <li><a href="/tutorial-entrenador.html" class="active">Tutorial</a></li>
      <li><a href="/roles/entrenador.html">Dashboard</a></li>
      <li><a href="/roles/perfil.html" class="active">Perfil</a></li>
      <li><a href="/logout">Cerrar Sesión</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <header class="role-header">
      <h1>Mi Perfil</h1>
      <p>Visualiza y actualiza tus datos de usuario</p>
    </header>

    <div class="profile-container">
      <!-- Foto de Perfil -->
      <div class="profile-photo-wrapper">
        <img src="/images/avatar-placeholder.png"
             alt="Foto de Perfil"
             id="profile-photo"
             class="profile-photo" />
        <label for="upload-input" class="upload-button" title="Subir foto">
          &#x1F4F7;
        </label>
        <input type="file" id="upload-input" class="upload-input" accept="image/*" />
      </div>

      <!-- Información del Usuario -->
      <ul class="profile-info-list">
        <li>
          <span class="profile-info-label">Email:</span>
          <span id="info-email">Cargando...</span>
        </li>
        <li>
          <span class="profile-info-label">Nombre:</span>
          <span id="info-nombre">Cargando...</span>
        </li>
        <li>
          <span class="profile-info-label">Edad:</span>
          <span id="info-edad">Cargando...</span>
        </li>
        <li>
          <span class="profile-info-label">Usuario:</span>
          <span id="info-username">Cargando...</span>
        </li>
        <li>
          <span class="profile-info-label">Rol:</span>
          <span id="info-role">Cargando...</span>
        </li>
      </ul>

      <!-- Botón para editar perfil -->
      <button class="edit-button" onclick="window.location.href='/roles/editar-perfil.html'">
        Editar Perfil
      </button>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p>&copy; 2025 CoachSync. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const profilePhoto = document.getElementById('profile-photo');
      const uploadInput = document.getElementById('upload-input');

      // 1) Obtener datos de usuario (incluida la foto)
      fetch('/api/me')
        .then(response => {
          if (!response.ok) {
            throw new Error('No se pudo cargar la información del usuario.');
          }
          return response.json();
        })
        .then(data => {
          document.getElementById('info-email').textContent = data.email;
          document.getElementById('info-nombre').textContent = data.nombre;
          document.getElementById('info-edad').textContent = data.edad;
          document.getElementById('info-username').textContent = data.username;
          const rol = data.role.startsWith('ROLE_')
                      ? data.role.substring(5).toLowerCase()
                      : data.role;
          document.getElementById('info-role').textContent =
            rol.charAt(0).toUpperCase() + rol.slice(1);

          // Si tiene foto guardada, mostrarla; sino el placeholder
          if (data.photoFilename) {
            profilePhoto.src = '/uploads/' + data.photoFilename;
          }
        })
        .catch(err => {
          console.error(err);
          // Si falla, mantenemos el placeholder y ponemos “No disponible”
          const spans = document.querySelectorAll('.profile-info-list span:nth-child(2)');
          spans.forEach(span => span.textContent = 'No disponible');
        });

      // 2) Manejar subida de foto: enviarla al servidor
     uploadInput.addEventListener('change', event => {
  const file = event.target.files[0];
  if (!file) return;

  // Mostrar preview inmediato
  const reader = new FileReader();
  reader.onload = e => {
    profilePhoto.src = e.target.result;
  };
  reader.readAsDataURL(file);

  // Enviar al servidor
  const formData = new FormData();
  formData.append('file', file);

  fetch('/api/me/photo', {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'  // <--- sin esto no llega cookie de sesión
  })
    .then(response => {
      if (!response.ok) {
        throw new Error('Error al subir la foto.');
      }
      // Todo bien; la próxima recarga mostrará la foto guardada en /uploads/
    })
    .catch(err => {
      console.error(err);
      alert('No se pudo subir la imagen. Intenta de nuevo.');
    });
});
    });
  </script>
</body>
</html>
